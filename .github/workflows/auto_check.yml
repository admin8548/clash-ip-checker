name: Auto Fetch and Check Nodes

on:
  schedule:
    # æ¯å¤©4æ¬¡å®šæ—¶è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: '0 0 * * *'   # æ—©ä¸Š 08:00 (UTC 00:00)
    - cron: '30 3 * * *'  # ä¸­åˆ 11:30 (UTC 03:30)
    - cron: '0 8 * * *'   # ä¸‹åˆ 16:00 (UTC 08:00)
    - cron: '0 12 * * *'  # æ™šä¸Š 20:00 (UTC 12:00)
  workflow_dispatch:  # ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½

jobs:
  process-nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. å‡†å¤‡ Python çŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. å®‰è£… Python ä¾èµ– (åŒ…å« Playwright)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml aiohttp
          pip install playwright
          playwright install chromium
          playwright install-deps

      # 4. ä¸‹è½½å¹¶åˆå¹¶è®¢é˜… (ç”Ÿæˆ config.yaml)
      - name: Download and Merge Subscriptions
        env:
          CLASH_SUB_URL: ${{ secrets.CLASH_SUB_URL }}
        run: |
          echo "=== Starting download_sub.py ==="
          echo "CLASH_SUB_URL is set: $([[ -n \"$CLASH_SUB_URL\" ]] && echo 'YES' || echo 'NO')"
          python -u download_sub.py
          echo "=== download_sub.py finished ==="
          echo "Checking generated files:"
          ls -la config.yaml 2>/dev/null || echo "config.yaml not found!"
          echo "First 20 lines of config.yaml:"
          head -20 config.yaml 2>/dev/null || echo "Cannot read config.yaml"

      # 5. ã€æ ¸å¿ƒæ­¥éª¤ã€‘ä¸‹è½½ Clash (Mihomo) å†…æ ¸
      - name: Setup Clash Kernel
        run: |
          # ä¸‹è½½ Mihomo (Clash Meta) å†…æ ¸
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-amd64-v1.18.1.gz
          gzip -d mihomo-linux-amd64-v1.18.1.gz
          mv mihomo-linux-amd64-v1.18.1 clash
          chmod +x clash

      # 6. ã€æ ¸å¿ƒæ­¥éª¤ã€‘é…ç½®å¹¶å¯åŠ¨ Clash
      - name: Start Clash in Background
        run: |
          # --- æ–°å¢žé…ç½®å¼€å§‹ ---
          # å¼ºåˆ¶å†™å…¥åŸºç¡€é…ç½®ï¼Œç¡®ä¿ Clash æ‰“å¼€ä»£ç†ç«¯å£
          echo "mixed-port: 7890" >> config.yaml
          echo "allow-lan: true" >> config.yaml
          echo "bind-address: '*'" >> config.yaml
          echo "mode: global" >> config.yaml
          echo "log-level: info" >> config.yaml
          # --- æ–°å¢žé…ç½®ç»“æŸ ---

          # ä¹‹å‰åŠ çš„æŽ§åˆ¶ç«¯å£é…ç½®
          echo "" >> config.yaml
          echo "external-controller: '0.0.0.0:9097'" >> config.yaml
          echo "secret: ''" >> config.yaml
          
          # åŽå°å¯åŠ¨ Clash
          nohup ./clash -d . -f config.yaml > clash.log 2>&1 &
          
          # ç­‰å¾…å¯åŠ¨
          echo "Waiting for Clash to start..."
          sleep 5
          
          # æµ‹è¯• API
          curl -v http://127.0.0.1:9097/version || echo "Clash start failed!"

      # 7. è¿è¡Œè‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬ (æ”¹ä¸º clash_automator.py)
      - name: Run Clash Automator
        run: |
          echo "=== Starting Clash Automator ==="
          echo "Python version: $(python --version)"
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          echo "=== Running script ==="
          # è¿™é‡Œçš„è„šæœ¬ä¼šè¿žæŽ¥æœ¬åœ° 9097 ç«¯å£æŽ§åˆ¶ Clash
          python -u clash_automator.py 2>&1 || echo "Script exited with error code: $?"
          echo "=== Script finished ==="
          echo "Checking output files:"
          ls -la *.yaml *.txt 2>/dev/null || echo "No output files found"

      # 8. å‘å¸ƒæ‰€æœ‰æ–‡ä»¶åˆ° Gist (åˆå¹¶æ­¥éª¤)
      - name: Deploy All Files to Gist
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          echo "ðŸ“¤ Deploying files to Gist..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "Checking output files:"
          ls -la config_checked.yaml config_checked_v2rayn.txt report.md 2>/dev/null || true
          
          # ä½¿ç”¨ GitHub API æ›´æ–° Gist
          # æž„å»º JSON payload
          python3 << 'EOF'
          import json
          import os
          import requests
          
          gist_id = os.environ.get('GIST_ID', '')
          token = os.environ.get('GIST_PAT', '')
          
          if not gist_id or not token:
              print("âŒ Error: GIST_ID or GIST_PAT not set")
              exit(1)
          
          files = {}
          
          # Clash è®¢é˜…
          if os.path.exists('config_checked.yaml'):
              with open('config_checked.yaml', 'r', encoding='utf-8') as f:
                  files['clash_subs.yaml'] = {'content': f.read()}
              print("âœ… Added: clash_subs.yaml")
          else:
              print("âš ï¸ Missing: config_checked.yaml")
          
          # v2rayN è®¢é˜…
          if os.path.exists('config_checked_v2rayn.txt'):
              with open('config_checked_v2rayn.txt', 'r', encoding='utf-8') as f:
                  files['v2rayn_subs.txt'] = {'content': f.read()}
              print("âœ… Added: v2rayn_subs.txt")
          else:
              print("âš ï¸ Missing: config_checked_v2rayn.txt")
          
          # ç»Ÿè®¡æŠ¥å‘Š
          if os.path.exists('report.md'):
              with open('report.md', 'r', encoding='utf-8') as f:
                  files['report.md'] = {'content': f.read()}
              print("âœ… Added: report.md")
          else:
              print("âš ï¸ Missing: report.md")
          
          if not files:
              print("âŒ No files to upload!")
              exit(1)
          
          # è°ƒç”¨ GitHub API
          url = f"https://api.github.com/gists/{gist_id}"
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          payload = {'files': files}
          
          response = requests.patch(url, headers=headers, json=payload)
          
          if response.status_code == 200:
              print(f"âœ… Successfully updated Gist!")
              print(f"   Files uploaded: {len(files)}")
              for name in files.keys():
                  print(f"   - {name}")
          else:
              print(f"âŒ Failed to update Gist: {response.status_code}")
              print(response.text)
              exit(1)
          EOF
